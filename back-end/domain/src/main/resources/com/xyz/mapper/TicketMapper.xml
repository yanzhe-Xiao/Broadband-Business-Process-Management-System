<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xyz.mapper.TicketMapper">

    <resultMap id="BaseResultMap" type="com.xyz.ticket.Ticket">
            <id property="id" column="ID" />
            <result property="orderId" column="ORDER_ID" />
            <result property="status" column="STATUS" />
            <result property="assigneeId" column="ASSIGNEE_ID" />
            <result property="note" column="NOTE" />
            <result property="dispatchedAt" column="DISPATCHED_AT" />
            <result property="completedAt" column="COMPLETED_AT" />
            <result property="deleted" column="DELETED" />
            <result property="deletedAt" column="DELETED_AT" />
            <result property="createdAt" column="CREATED_AT" />
            <result property="updatedAt" column="UPDATED_AT" />
    </resultMap>

    <sql id="Base_Column_List">
        ID,ORDER_ID,STATUS,ASSIGNEE_ID,NOTE,DISPATCHED_AT,
        COMPLETED_AT,DELETED,DELETED_AT,CREATED_AT,UPDATED_AT
    </sql>

    <sql id="ticketSelectCols">
        t.id              AS id,
        t.order_id        AS orderId,
        t.status          AS status,
        t.assignee_id     AS assigneeId,
        t.note            AS note,
        t.dispatched_at   AS dispatchedAt,
        t.completed_at    AS completedAt,
        t.created_at      AS createdAt,
        t.updated_at      AS updatedAt,

        -- Orders
        o.install_address AS installAddress,

        -- Engineer (app_user)
        u.username        AS engineerUsername,
        u.full_name       AS engineerFullName,
        u.phone           AS engineerPhone,
        u.email           AS engineerEmail
    </sql>

    <select id="selectTicketPage" resultType="com.xyz.vo.TicketPageVO">
        SELECT
        <include refid="ticketSelectCols"/>
        FROM ticket t
        LEFT JOIN orders    o ON o.id     = t.order_id
        LEFT JOIN app_user  u ON u.id     = t.assignee_id
        <where>
            <if test="status != null and status != ''">
                AND t.status = #{status}
            </if>
            <if test="engineer != null and engineer != ''">
                AND (u.username LIKE CONCAT('%', #{engineer}, '%')
                OR  u.full_name LIKE CONCAT('%', #{engineer}, '%'))
            </if>
            <if test="addressKw != null and addressKw != ''">
                AND o.install_address LIKE CONCAT('%', #{addressKw}, '%')
            </if>
        </where>
        ORDER BY t.id DESC
    </select>

    <select id="exportTicketList" resultType="com.xyz.vo.TicketPageVO">
        SELECT
        <include refid="ticketSelectCols"/>
        FROM ticket t
        LEFT JOIN orders    o ON o.id     = t.order_id
        LEFT JOIN app_user  u ON u.id     = t.assignee_id
        <where>
            <if test="status != null and status != ''">
                AND t.status = #{status}
            </if>
            <if test="engineer != null and engineer != ''">
                AND (u.username LIKE CONCAT('%', #{engineer}, '%')
                OR  u.full_name LIKE CONCAT('%', #{engineer}, '%'))
            </if>
            <if test="addressKw != null and addressKw != ''">
                AND o.install_address LIKE CONCAT('%', #{addressKw}, '%')
            </if>
        </where>
        ORDER BY t.id DESC
    </select>
    <select id="selectOneByOrderId" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from TICKET
        where
        ORDER_ID = #{orderId,jdbcType=NUMERIC}
    </select>
</mapper>
